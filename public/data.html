<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div style="margin-left: 5px;margin-right: 5px;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Zoom Attendance Manager</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="data.html">Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="container">
        <h1>Data</h1>

        <div class="container">
            <div class="mb-3">
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#clearDataModal">
                    Clear all local data
                </button>
            </div>
            <div class="mb-3">
                <label for="fileZoomCSV" class="form-label">Upload one or more Zoom attendance CSV files.</label>
                <input class="form-control" type="file" id="fileZoomCSV" multiple>
            </div>
            <div class="mb-3">
                <h2>Meetings</h2>
                <div id="meetingList" class="container"></div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="clearDataModal" tabindex="-1" aria-labelledby="clearDataModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearDataModalLabel">Are you sure you want to clear all local data?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This will remove any data or settings that you have accumulated. You will have to upload your
                    attendance reports and re-do all configuration settings.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="clearData()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- code -->

    <script type="text/javascript">

        var DateTime = luxon.DateTime;
        const CSV_DATE_FORMAT = "LL/dd/yyyy hh:mm:ss a";
        const JSON_DATE_FORMAT = "LL/dd/yyyy HH:mm";

        var students = null;
        var meetings = null;

        function saveObj(key, obj) {
            var buf = JSON.stringify(obj);
            localStorage.setItem(key, buf);
        }

        function clearData(){
            localStorage.clear();
            $('#clearDataModal').modal('hide');
        }

        window.addEventListener("load", (event) => {
            students = localStorage.getItem("students");
            if (students == null) {
                students = {};
                saveObj("students", students);
            }

            meetingsData = localStorage.getItem("meetings");
            if (meetingsData == null) {
                meetings = {};
                saveObj("meetings", meetings);
            } else {
                meetings = JSON.parse(meetingsData);
                populateMeetings();
            }

        });

        function extractDateString(){
            var dt = DateTime.fromFormat()
        }

        function populateMeetings() {
            $('#meetingList').empty();
            var ids = Object.keys(meetings);
            for (var i = 0; i < ids.length; i++) {
                var meeting = meetings[ids[i]];
                var name = meeting.topic;
                var dt = DateTime.fromFormat(meeting.startTime, CSV_DATE_FORMAT)
                var date = dt.toLocaleString(DateTime.DATE_SHORT);
                var start = dt.toLocaleString(DateTime.TIME_SIMPLE);

                dt = DateTime.fromFormat(meeting.endTime, CSV_DATE_FORMAT);
                var end = dt.toLocaleString(DateTime.TIME_SIMPLE);

                var duration = meeting.duration;

                var div = `<div class="row">${name} ${date} ${start} ${end} ${duration}m</div>`;

                $('#meetingList').append(div);
            }
        }

        const fileInput = document.getElementById("fileZoomCSV");
        fileInput.addEventListener("change", () => {
            const files = fileInput.files;
            processFiles(files);
        });

        function processRecords(records) {
            for (var i = 0; i < records.length; i++) {
                var topic = records[i].Topic;
                if (topic != null) {
                    if (typeof meetings[topic] == 'undefined') {
                        // then add it
                        var meeting = {
                            "id": records[i]["ID"],
                            "topic": records[i]["Topic"],
                            "startTime": records[i]["Start time"],
                            "endTime": records[i]["End time"],
                            "duration": records[i]["Duration (minutes)"],
                            "participants": records[i]["Participants"]
                        }
                        meetings[records[i]["ID"]] = meeting;
                    }
                    var email = records[i].Email;
                    var joined = records[i]["Join time"];
                    var left = records[i]["Leave time"];
                    var duration = records[i]["Duration (minutes)_1"];
                    // console.log( `${topic} ${email} ${joined} ${left}`)
                }

            }
            saveObj("meetings", meetings);
            console.log(JSON.stringify(meetings));
            saveObj("records", records);
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            const fileContent = event.target.result; // Get the file content
            var records = Papa.parse(fileContent, { "dynamicTyping": true, "header": true });
            var record = records.data[0];
            processRecords(records.data);
        };

        function processFiles(files) {
            for (const file of files) {
                reader.readAsText(file); // Read the file as text (or use readAsDataURL for images)
            }
        }


    </script>
</body>

</html>