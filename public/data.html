<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div style="margin-left: 5px;margin-right: 5px;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Zoom Attendance Manager</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="data.html">Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="container">
        <h1>Data</h1>

        <div class="container">
            <div class="mb-3">
                <label for="fileZoomCSV" class="form-label">Default file input example</label>
                <input class="form-control" type="file" id="fileZoomCSV" multiple>
            </div>
        </div>

    </div>

    <!-- code -->

    <script type="text/javascript">

        var DateTime = luxon.DateTime;
        const CSV_DATE_FORMAT = "LL/dd/yyyy hh:mm:ss a";
        const JSON_DATE_FORMAT = "LL/dd/yyyy HH:mm";

        var students = null;
        var meetings = null;

        function saveObj(key, obj) {
            var buf = JSON.stringify(obj);
            localStorage.setItem(key, buf);
        }

        window.addEventListener("load", (event) => {
            students = localStorage.getItem("students");
            if (students == null) {
                students = {};
                saveObj("students", students);
            }

            meetings = localStorage.getItem("meetings");
            if (meetings == null) {
                meetings = {};
                saveObj("meetings", meetings);
            }
        });

        const fileInput = document.getElementById("fileZoomCSV");
        fileInput.addEventListener("change", () => {
            const files = fileInput.files;
            processFiles(files);
        });

        function processRecords(records){
            for( var i=0;i<records.length; i++){
                var topic = records[i].Topic;
                if( topic != null ) {
                    if( typeof meetings[topic] == 'undefined' ){
                        // then add it
                        var startTime = DateTime.fromFormat(records[i]["Start time"], CSV_DATE_FORMAT);
                        var endTime = DateTime.fromFormat(records[i]["End time"], CSV_DATE_FORMAT);
                        console.log( records[i]["Start time"] + " -> " + startTime.toFormat(JSON_DATE_FORMAT) );
                    }
                    var email = records[i].Email;
                    var joined = records[i]["Join time"];
                    var left = records[i]["Leave time"];
                    // console.log( `${topic} ${email} ${joined} ${left}`)
                }

            }
            saveObj("records", records);
        }

        function processFiles(files) {
            for (const file of files) {
                const reader = new FileReader();

                reader.onload = (event) => {
                    const fileContent = event.target.result; // Get the file content
                    var records = Papa.parse(fileContent, { "dynamicTyping": true, "header": true });
                    processRecords(records.data);
                };

                reader.readAsText(file); // Read the file as text (or use readAsDataURL for images)
            }
        }


    </script>
</body>

</html>