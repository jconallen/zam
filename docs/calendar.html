<!DOCTYPE html>
<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"
        integrity="sha256-Ij/4AKCwuHoclsHRJ6mpgUNOFPiKexZi/sreF8eOogM=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">

    <style>
        hover-end{padding:0;margin:0;font-size:75%;text-align:center;position:absolute;bottom:0;width:100%;opacity:.8}
    </style>

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1>Calendar</h1>
        <div class="w-75 container">
            <div id="calendar" ></div>
        </div>
    </div>

    <!-- code -->
    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        var calendar;

        window.addEventListener("load", async (event) => {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth'
            });
            calendar.render();

            calendar.on('dateClick', function (info) {
                console.log('clicked on ' + info.dateStr);
            });

            calendar.on('eventClick', function (info) {
                console.log('Event on ' + JSON.stringify(info.event.extendedProps) );
                var url = info.event.extendedProps.meetingInstanceUrl;
                navigate(url);
            });

            calendar.on('eventMouseover', function (event) {
                $('.fc-event-inner', this).append('<div id=\"'+event.id+'\" class=\"hover-end\">h:mmt</div>');
                console.log('Mouse over on ' + JSON.stringify(info.event.extendedProps) );
            });

            console.log( "about to pop events")
            await populateEvents();

        });

        async function addEvent(instance) {
            try{
                console.log( "adding event" );
                var meeting = await getRecord('meetings', instance.meetingId );
                var dtStart = DateTime.fromFormat(instance.start, CSV_DATE_FORMAT);
                var startDateSimple = dtStart.toLocaleString(DateTime.DATE_SHORT);
                var dtEnd = DateTime.fromFormat(instance.end, CSV_DATE_FORMAT);
                var parsedEnd = parseDateString(instance.end);
                var meetingInstanceUrl = "meetingInstance.html?meetingId="+encodeURIComponent(instance.meetingId)+"&startDate="+encodeURIComponent(startDateSimple);
                var event = {
                    "title": meeting.topic,
                    "allDay": false,
                    "start": dtStart.toISO(),
                    "end": dtEnd.toISO(),
                    "meetingInstanceUrl": meetingInstanceUrl
                }
                calendar.addEvent(event);
            } catch(err){ 
                console.error( err );
            }

        }

        async function populateEvents(){

            try{
                console.log( "populating events");
                var meetingInstances = await getAll('meetingInstances');
                    async.eachSeries(meetingInstances, addEvent, (err) => {
                    if (err) console.error(err);
                });
            } catch(err ) {
                console.error( err );
            }
        }

    </script>
</body>

</html>