<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1 id="studentName"></h1>

        <div class="container">

        </div>

        <h3>Attendance Records</h3>
        <div id="attendanceRecords" class="container">
        </div>
    </div>

    <!-- code -->
    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        window.addEventListener("load", async (event) => {
            await initDb();

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const email = urlParams.get('email');
            await buildStudentDetailsDiv(email);
            await updateAttendanceBars();
        });
        //window.addEventListener("resize", drawAttendanceBar);

        async function updateAttendanceBars() {
            async.eachSeries(barData, drawAttendanceBar, (err) => {
                if (err) console.error(err);
            });
        }

        async function drawAttendanceBar(barData) {

            //const canvas = $('#canvas'+barData.index);
            const canvas = document.getElementById('canvas' + barData.index);
            if (canvas) {
                console.log("Canvas " + barData.index + " width: " + canvas.width + ", height: " + canvas.height);
                // fitToContainer(canvas);
                var attendance = barData.attendance;
                var dtMeetingStart = DateTime.fromFormat(attendance.start, CSV_DATE_FORMAT);
                var meetingStartTime = dtMeetingStart.toLocaleString(DateTime.TIME_SIMPLE);
                var dtMeetingEnd = DateTime.fromFormat(attendance.end, CSV_DATE_FORMAT);
                var dtJoined = DateTime.fromFormat(attendance.joined, CSV_DATE_FORMAT);
                var dtLeft = DateTime.fromFormat(attendance.left, CSV_DATE_FORMAT);
                var joinedTimeSimple = dtJoined.toLocaleString(DateTime.TIME_SIMPLE);
                var left = DateTime.fromFormat(attendance.left, CSV_DATE_FORMAT);
                var leftTimeSimple = dtLeft.toLocaleString(DateTime.TIME_SIMPLE);
                var meetingDuration = attendance.meetingDuration;

                var scale = canvas.width / meetingDuration;

                var minIn = Math.ceil(dtJoined.diff(dtMeetingStart, 'minutes').minutes);
                var minOut = Math.ceil(dtLeft.diff(dtMeetingStart, 'minutes').minutes);

                console.log("minIn: " + minIn + " minOut: " + minOut + " scale: " + scale + " meetingStart: " + meetingStartTime);

                var pxIn = scale * minIn;
                var pxOut = scale * minOut

                var height = canvas.height;

                const ctx = canvas.getContext("2d");
                ctx.fillStyle = 'red';

                ctx.fillRect(pxIn, 0, pxOut, height);

            }
        }

        function fitToContainer(canvas) {
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        function sortAttendance(attendanceRecords) {
            var sortedInstances = attendanceRecords.sort((a, b) => {
                var aJoined = DateTime.fromFormat(a.joined, CSV_DATE_FORMAT);
                var bJoined = DateTime.fromFormat(b.joined, CSV_DATE_FORMAT);
                return bJoined.diff(aJoined);
            });
            return sortedInstances;
        }

        var barData = [];

        async function buildStudentDetailDiv(attendance) {
            console.log( "building detal div");
            var meetingId = attendance.meetingId;
            var meeting = await getRecord('meetings', meetingId);
            if (!meeting.ignore) {
                var dtAttendanceStart = DateTime.fromFormat(attendance.start, CSV_DATE_FORMAT);
                var attendanceStartTimeSimple = dtAttendanceStart.toLocaleString(DateTime.TIME_SIMPLE);
                var attendanceStartDateShort = dtAttendanceStart.toLocaleString(DateTime.DATE_SHORT);

                const meetingInstance = await getRecord('meetingInstances', [meetingId,attendanceStartDateShort]);
                var dtMeetingInstanceStart = DateTime.fromFormat(meetingInstance.start, CSV_DATE_FORMAT);
                var meetingInstanceStartSimple = dtMeetingInstanceStart.toLocaleString(DateTime.TIME_SIMPLE);
                var dtMeetingInstanceEnd = DateTime.fromFormat(meetingInstance.end, CSV_DATE_FORMAT);
                var meetingInstanceEndSimple = dtMeetingInstanceEnd.toLocaleString(DateTime.TIME_SIMPLE);

                var prevJoinedDateShort = null;
                var dtJoined = DateTime.fromFormat(attendance.joined, CSV_DATE_FORMAT);
                var joinDateShort = dtJoined.toLocaleString(DateTime.DATE_SHORT);
                if (prevJoinedDateShort != joinDateShort) {
                    var meetingDuration = meeting.duration;
                    // ${joinDateShort} - ${meeting.topic} (${meetingInstanceStartSimple} -> ${meetingInstanceEndSimple})
                    var div = `<div class="row" style="padding-top:10px;">${joinDateShort} - ${meeting.topic} (${meetingInstanceStartSimple} -> ${meetingInstanceEndSimple})</div>`;
                    $('#attendanceRecords').append(div);
                    prevJoinedDateShort = joinDateShort;
                }
                var dtLeft = DateTime.fromFormat(attendance.left, CSV_DATE_FORMAT);
                var joinedTimeSimple = dtJoined.toLocaleString(DateTime.TIME_SIMPLE);
                var left = DateTime.fromFormat(attendance.left, CSV_DATE_FORMAT);
                var leftTimeSimple = dtLeft.toLocaleString(DateTime.TIME_SIMPLE);

                var index = barData.length;
                var bd = {
                    "attendance": attendance,
                    "meetingDuration": meeting.duration,
                    "index": barData.length
                }
                barData.push(bd);

                // add attendance bar
                var div = `<div class="row" style="padding-left: 20px;">
                                        <div class="col-3" style="padding-left:15px;">${joinedTimeSimple} -> ${leftTimeSimple} (${attendance.duration})</div>
                                        <div class="col-5" style="height:20px;">
                                            <canvas id="canvas${index}" style="width:100%;height:100%;border-style:solid;border-width:1px;"></canvas>
                                        </div></div>`;
                $('#attendanceRecords').append(div);

            }
            console.log( "done building detal div");
        }

        async function buildStudentDetailsDiv(email) {
            return new Promise(async (resolve, reject) => {
                var student = await getRecord('students', email);
                if (student) {
                    $('#studentName').text(student.name);
                    // todo: just get the records for this student
                    var attendance = await getAll('attendance');
                    var studentAttendance = [];
                    for (var i = 0; i < attendance.length; i++) {
                        var record = attendance[i];
                        if (record.email == email) {
                            studentAttendance.push(record);
                        }
                    }

                    // now sort by date / time
                    var sortedAttendance = sortAttendance(studentAttendance);
                    var prevJoinedDateShort = null; // break up records according to dates
                    await async.eachSeries(sortedAttendance,buildStudentDetailDiv, (err) => {
                        console.log( "finished build div");
                        resolve();
                    });

                } else {
                    alert("unable to get student information for : " + email);
                    reject(email);
                }
            });
        }

    </script>
</body>

</html>