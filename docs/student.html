<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1 id="studentName"></h1>

        <h3>Attendance Records</h3>
        <div id="attendanceRecords" class="container"></div>
    </div>

    <!-- code -->
    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        var DateTime = luxon.DateTime;
        const CSV_DATE_FORMAT = "LL/dd/yyyy hh:mm:ss a";
        const JSON_DATE_FORMAT = "LL/dd/yyyy HH:mm";
        
        window.addEventListener("load", async (event) => {
            await initDb();

            const queryString = window.location.search; 
            const urlParams = new URLSearchParams(queryString);
            const email = urlParams.get('email');
            buildStudentDetailsDiv(email);
        });

        function sortAttendance(attendanceRecords){
            var sortedInstances = attendanceRecords.sort((a, b) => {
                var aJoined = DateTime.fromFormat(a.joined, CSV_DATE_FORMAT);
                var bJoined = DateTime.fromFormat(b.joined, CSV_DATE_FORMAT);
                return aJoined.diff( bJoined );
            });
            return sortedInstances;
        }

        async function buildStudentDetailsDiv(email){
            var student = await getRecord('students', email);
            if( student ){
                $('#studentName').text(student.name);
                // todo: just get teh records for this student
                var attendance = await getAll('attendance');
                var studentAttendance = [];
                for( var i=0; i<attendance.length; i++){
                    var record = attendance[i];
                    if( record.email == email ) {
                        studentAttendance.push(record);
                    } 
                }

                // now sort by date / time
                var sortedAttendance = sortAttendance(studentAttendance);
                var prevJoinedDateShort = null; // break up records according to dates
                for( var i=0; i<sortedAttendance.length; i++){
                    var attendance = sortedAttendance[i];
                    var meetingId = attendance.meetingId;
                    var meeting = await getRecord('meetings', meetingId);
                    if( !meeting.ignore ) {
                        var joined = DateTime.fromFormat(attendance.joined, CSV_DATE_FORMAT);
                        var joinDateShort = joined.toLocaleString(DateTime.DATE_SHORT);
                        if( prevJoinedDateShort != joinDateShort ) {
                            var meetingDuration = meeting.duration;
                            var div = `<div class="row" style="padding-top:10px;">${joinDateShort} - ${meeting.topic}</div>`;
                            $('#attendanceRecords').append(div);
                            prevJoinedDateShort = joinDateShort;
                        }
                        var joinedTimeSimple = joined.toLocaleString(DateTime.TIME_SIMPLE);
                        var left = DateTime.fromFormat(attendance.left, CSV_DATE_FORMAT);
                        var leftTimeSimple = left.toLocaleString(DateTime.TIME_SIMPLE);
                        var div = `<div class="row" style="padding-left: 20px;">${joinedTimeSimple} -> ${leftTimeSimple}, ${attendance.duration}m</div>`;
                        $('#attendanceRecords').append(div);
                    }
                }

            } else {
                alert("unable to get student information for : " + email);
            }

        }



    </script>
</body>

</html>