<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div style="margin-left: 5px;margin-right: 5px;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Zoom Attendance Manager</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="data.html">Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="container">
        <h1>Data</h1>

        <div class="container">
            <div class="mb-3">
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#clearDataModal">
                    Clear all local data
                </button>
            </div>
            <div class="mb-3">
                <label for="fileZoomCSV" class="form-label">Upload one or more Zoom attendance CSV files.</label>
                <input class="form-control" type="file" id="fileZoomCSV" multiple>
            </div>
            <div class="mb-3">
                <h2>Courses</h2>
                <div id="meetingList" class="container"></div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="clearDataModal" tabindex="-1" aria-labelledby="clearDataModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearDataModalLabel">Are you sure you want to clear all local data?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This will remove any data or settings that you have accumulated. You will have to upload your
                    attendance reports and re-do all configuration settings.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="clearData()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- code -->

    <script type="text/javascript">

        var DateTime = luxon.DateTime;
        const CSV_DATE_FORMAT = "LL/dd/yyyy hh:mm:ss a";
        const JSON_DATE_FORMAT = "LL/dd/yyyy HH:mm";

        var students = null;
        var meetings = null;

        function saveObj(key, obj) {
            var buf = JSON.stringify(obj);
            localStorage.setItem(key, buf);
        }

        function clearData() {
            $('#clearDataModal').modal('hide');
            localStorage.clear();
            students = {};
            meetings = {};
            $('#meetingList').empty();
        }

        window.addEventListener("load", (event) => {
            students = localStorage.getItem("students");
            if (students == null) {
                students = {};
                saveObj("students", students);
            }

            meetingsData = localStorage.getItem("meetings");
            if (meetingsData == null) {
                meetings = {};
                saveObj("meetings", meetings);
            } else {
                meetings = JSON.parse(meetingsData);
                populateMeetings();
            }

        });

        function extractDateString() {
            var dt = DateTime.fromFormat()
        }

        function sortInstances(instances) {
            return instances.sort(function (a, b) {
                var aTime = DateTime.fromFormat(a, CSV_DATE_FORMAT);
                var bTime = DateTime.fromFormat(b, CSV_DATE_FORMAT);
                return aTime.diff(bTime, 'minutes');
            });
        }

        function populateMeetings() {
            $('#meetingList').empty();
            var ids = Object.keys(meetings);
            for (var i = 0; i < ids.length; i++) {
                var meeting = meetings[ids[i]];
                var name = meeting.topic;

                var div = `<div class="row">${name}</div>`;
                $('#meetingList').append(div);

                var instanceTimes = sortInstances(Object.keys(meeting.instances));
                for (var j = 0; j < instanceTimes.length; j++) {
                    var startTime = instanceTimes[j];
                    var dt = DateTime.fromFormat(startTime, CSV_DATE_FORMAT);
                    var date = dt.toLocaleString(DateTime.DATE_SHORT);
                    var start = dt.toLocaleString(DateTime.TIME_SIMPLE);

                    var instance = meeting.instances[startTime];
                    var endTime = instance["endTime"];
                    dt = DateTime.fromFormat(endTime, CSV_DATE_FORMAT);
                    var end = dt.toLocaleString(DateTime.TIME_SIMPLE);
                    var duration = instance["duration"];
                    var participants = instance["participants"];

                    var div = `<div class="row"><div class="col-1"></div><div class="col-10">${date} ${start} ${end} ${duration}m ${participants}</div></div>`;

                    $('#meetingList').append(div);
                }


            }
        }

        const fileInput = document.getElementById("fileZoomCSV");
        fileInput.addEventListener("change", () => {
            const files = fileInput.files;
            processFiles(files);
        });

        function processRecords(records) {
            return new Promise( (resolve, reject) => {
                for (var i = 0; i < records.length; i++) {
                    var topic = records[i].Topic;
                    if (topic != null) {
                        var meetingId = records[i].ID;
                        var meeting = meetings[meetingId];
                        if (typeof meetings[meetingId] == 'undefined') {
                            // then add it
                            meeting = {
                                "id": records[i]["ID"],
                                "topic": records[i]["Topic"],
                                "ignore": false,
                                "instances": {}
                            }
                            meetings[meetingId] = meeting;
                        }

                        // now add the instance
                        var meetingInstance = {
                            "startTime": records[i]["Start time"],
                            "endTime": records[i]["End time"],
                            "duration": records[i]["Duration (minutes)"],
                            "participants": records[i]["Participants"],
                        }

                        if (!meeting.instances[meetingInstance.startTime]) {
                            meeting.instances[meetingInstance.startTime] = meetingInstance;
                        }

                        // now process student info

                        var email = records[i].Email;
                        var joined = records[i]["Join time"];
                        var left = records[i]["Leave time"];
                        var duration = records[i]["Duration (minutes)_1"];

                        if (!students[email]) {
                            // initialize
                            students[email] = {
                                "name": records[i]["Name (original name)"],
                                "attendance": []
                            }
                        }

                        students[email].attendance.push({
                            "joined": joined,
                            "left": left,
                            "duration": duration
                        });

                    }

                    populateMeetings();

                }
                saveObj("meetings", meetings);
                saveObj("students", students);
                resolve();
            })
        }

        const reader = new FileReader();
        reader.onload = async (event) => {
            const fileContent = event.target.result; // Get the file content
            var records = Papa.parse(fileContent, { "dynamicTyping": true, "header": true });
            var record = records.data[0];
            await processRecords(records.data);
        };
        reader.onerror = function () {
            console.error("Error reading file");
        };

        function processFiles(files) {
            for (const file of files) {
                console.log("Reading file: " + file.name);
                reader.readAsText(file); // Read the file as text (or use readAsDataURL for images)
            }
        }


    </script>
</body>

</html>