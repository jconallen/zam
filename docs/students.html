<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1>Students</h1>

        <div id="studentList" class="container">

        </div>

    </div>

    <!-- code -->

    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        window.addEventListener("load", async (event) => {
            await initDb();
            populateStudents();

        });

        function searchForMeetingInstance( meetingId, start, meetingInstances ){
            // yeah, I know this is wasteful, to TODO: fix this to more performant and elegant
            for( var i=0; i<meetingInstances.length; i++){
                var meetingInstance = meetingInstances[i];
                var dtMeetingInstance
                if( meetingInstance.meetingId == meetingId && meetingInstance.start == start ){
                    return meetingInstance;
                }
            }
        }

        async function attendanceStats( email, allAttendanceRecords, meetingInstances ){
    
            var meetingInstanceDurationCache = {};
            var inClassMinutes = 0;
            var recordCount = 0;
            for( var i=0; i<allAttendanceRecords.length; i++){
                if( allAttendanceRecords[i].email == email ) {
                    var meetingId = allAttendanceRecords[i].meetingId;
                    var dtStart = DateTime.fromFormat(allAttendanceRecords[i].start, CSV_DATE_FORMAT);
                    var startSimple = dtStart.toLocaleString(DateTime.DATE_SHORT);
                    var meetingInstance = meetingInstancesCache[ meetingId + startSimple ];
                    if( meetingInstance ) {
                        var dtMeetingStart = DateTime.fromFormat(allAttendanceRecords[i].start, CSV_DATE_FORMAT);
                        var meetingStart = dtMeetingStart.toLocaleString(DateTime.DATE_SHORT);
                        var key = meetingId +","+meetingStart;
                        meetingInstanceDurationCache[key] = meetingInstance.duration;
                        var recordEmail = allAttendanceRecords[i].email;
                        if( recordEmail == email ) recordCount++;
                        // get in class time minutes
                        inClassMinutes += allAttendanceRecords[i].duration;
                    } else {
                        console.error( meetingId + " " + allAttendanceRecords[i].start  );
                    }
                }
            }
            // now sum up the meeting durations
            var totalClassMinutes = 0;
            var keys = Object.keys(meetingInstanceDurationCache);
            for( var i=0; i<keys.length; i++){
                var meetingInstanceDuration = meetingInstanceDurationCache[ keys[i] ];
                totalClassMinutes += meetingInstanceDuration;
            }
            var stats = {
                "recordCount": recordCount,
                "inClassMinutes": inClassMinutes,
                "totalClassMinutes": totalClassMinutes
            }
            return stats;
        }

        var meetingInstancesCache = {};

        async function populateStudents() {
            // $('#studentPre').text( JSON.stringify(students,null,4));
            // $('#studentList').empty();
            var meetingInstances = await getAll('meetingInstances');
            for( var i=0; i<meetingInstances.length;i++){
                var meetingInstance = meetingInstances[i];
                var dtStart = DateTime.fromFormat(meetingInstance.start, CSV_DATE_FORMAT);
                var startSimple = dtStart.toLocaleString(DateTime.DATE_SHORT);
                var key = meetingInstance.meetingId + startSimple;
                meetingInstancesCache[ key ] = meetingInstance;
            }
            var allAttendanceRecords = await getAll('attendance');
            var students = await getAll('students');
            for (var i = 0; i < students.length; i++) {
                var student = students[i];
                if( student.email != null ) {
                    // email can be null if this is a personal meeting or not one 
                    // that requires a school email account 

                    var stats = await attendanceStats( student.email, allAttendanceRecords, meetingInstances );
                    var inClassPercentage = Math.round(100 * stats.inClassMinutes / stats.totalClassMinutes);
                    var encodedEmail = encodeURIComponent(student.email);
                    var div = `<div class="row rounded border w-50" style="padding:5px;margin:5px;"><a href="student.html?email=${encodedEmail}">${student.name}</a>
                        <p style="margin-left:10px;">Recorded attendances: ${stats.recordCount}</br>
                        In class minutes: ${stats.inClassMinutes} out of ${stats.totalClassMinutes} for instances attended (${inClassPercentage}%).</p></div>`;
                    $('#studentList').append(div);
                }
            }
        }



    </script>
</body>

</html>