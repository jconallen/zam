<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div id="navbar"></div>
    <div class="container">
        <h1>Attendance Data</h1>

        <div class="container">
            <div class="mb-3">
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#clearDataModal">
                    Clear all local data
                </button>
            </div>
            <div class="mb-3">
                <label for="fileZoomCSV" class="form-label">Upload one or more Zoom attendance CSV files.</label>
                <input class="form-control" type="file" id="fileZoomCSV" multiple>
            </div>
            <div class="mb-3">
                <h2>Meetings</h2>
                <div id="meetingList" class="container"></div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="clearDataModal" tabindex="-1" aria-labelledby="clearDataModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearDataModalLabel">Are you sure you want to clear all local data?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This will remove any data or settings that you have accumulated. You will have to upload your
                    attendance reports and re-do all configuration settings.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="clearData()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- code -->

    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        window.addEventListener("load", async (event) => {
            await initDb();
            await buildMeetingDiv();
        });

        function sortMeetings(meetings){
            var sortedMeetings = meetings.sort((a, b) => {
                if( a.ignore == b.ignore ){
                    return b.topic.localeCompare( a.topic );
                }
                return a.ignore > b.ignore ? 1 : -1;
            });
        }

        async function buildMeetingDiv(){
            var meetings = await getAll("meetings");
            var sortedMeetings = sortMeetings(meetings);
            for( var i=0;i<meetings.length; i++){
                var meeting = meetings[i];
                var icon = "bi-eye";
                if( meeting.ignore ){
                    icon = "bi-eye-slash"
                }
                var id = meeting.meetingId.replace(/\s+/g, '');
                var div = `<div class="row"><span id="${id}" class="bi ${icon}" onclick="toggleVisibility('${meeting.meetingId}')">&nbsp;${meeting.topic}</span></div>`;

                $('#meetingList').append(div);
            }
        }

        async function toggleVisibility(meetingId){
            var meeting = await getRecord('meetings',meetingId);
            var id = meeting.meetingId.replace(/\s+/g, '');
            var elm = $('#'+id);
            if( meeting.ignore ) {
                meeting.ignore = false;
                elm.removeClass('bi-eye');
                elm.removeClass('bi-eye-slash');
                elm.addClass('bi-eye');
            } else {
                meeting.ignore = true;
                elm.removeClass('bi-eye');
                elm.removeClass('bi-eye-slash');
                elm.addClass('bi-eye-slash');
            }
            await updateRecord('meetings',meeting);
        }

        const fileInput = document.getElementById("fileZoomCSV");
        fileInput.addEventListener("change", () => {
            const files = fileInput.files;
            processFiles(files);
        });

        async function processRecord(record){
            if( record.Topic != null && record["Email"] != null) { // not undefined
                try{
                    var meetingId = record.ID;
                    var meeting;
                    // first make sure it isn't already in the db
                    if( meetingId ){
                        meeting = await getRecord('meetings', meetingId);
                        if( meeting == null ){
                            var meetingTopic = record.Topic;
                            var meeting = {
                                "meetingId": meetingId,
                                "topic": meetingTopic,
                                "ignore": false
                            }
                            await addRecord('meetings', meeting);
                        }
                    }

                    // now add an instance
                    var meetingStart = record["Start time"];
                    var meetingKey = [ meetingId, meetingStart ];
                    var instance = await getRecord( "meetingInstances", meetingKey );
                    if( instance ) {
                        console.log( JSON.stringify(instance) );
                    } else {
                        // add the instance
                        var meetingInstance = {
                            "meetingId": meetingId,
                            "start": meetingStart,
                            "end": record["End time"],
                            "duration": record["Duration (minutes)"],
                            "participants": record["Particpants"]
                        }
                        await addRecord( 'meetingInstances', meetingInstance)
                    }

                    // now create students
                    var email = record.Email;
                    if( email != null && typeof email != 'undefined' ){
                        // see if it i already there
                        var student = await getRecord('students', email);
                        if( student == null ){
                            var student = {
                                "email": email,
                                "name": record["Name (original name)"]
                            }
                            await addRecord('students', student);
                        }
                        // finally add attendance records
                        var joined = record["Join time"];
                        var attendance = await getRecord( "attendance", [ meetingId, meetingStart, joined] );
                        if( attendance ) {
                            console.log( JSON.stringify(attendance) );
                        } else {
                            // add the instance
                            var attendance = {
                                "meetingId": meetingId,
                                "start": meetingStart,
                                "email": email,
                                "joined": joined,
                                "left": record["Leave time"],
                                "duration": record["Duration (minutes)_1"]
                            }
                            await addRecord( 'attendance', attendance)
                        }

                    }

                    // now 
                }catch( err ) {
                    console.error( err );
                }
            }

        }

        async function processRecords(records){
            return new Promise( async ( resolve, reject) => {
                await async.eachSeries( records, processRecord );
                resolve();
            });
        }

        async function processFile(file){
            return new Promise( (resolve, reject) => {
                console.log( "Processing file: " + file.name );
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileContent = event.target.result; // Get the file content
                    var records = Papa.parse(fileContent, { "dynamicTyping": true, "header": true });
                    if (records.meta.fields.length == 25) {
                        // TODO: validate names 
                        try{
                            await async.eachSeries( records, processRecords );
                            // await async.eachSeries( records, processRecord );
                            resolve();
                        } catch( err ) {
                            console.error( err );
                            reject(err);
                        }
                    } else {
                        var msg = "Error parsing input file: " + file.name;
                        alert(msg);
                        reject( msg );
                    }
                };
                reader.onerror = function () {
                    console.error("Error reading file");
                };
                reader.readAsText(file); // Read the file as text (or use readAsDataURL for images)
            });
        }

        async function processFiles(files) {
            await async.eachSeries(files, processFile, function(err){
                if( err ) console.error(err);
            });
        }



    </script>
</body>

</html>