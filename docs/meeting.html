<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1>Meeting:</h1>
        <h2 id="topicName"></h2>

        <div id="meetingInstanceList" class="container"></div>
    </div>

    <!-- code -->
    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });
        
        window.addEventListener("load", async (event) => {
            await initDb();

            const queryString = window.location.search; 
            const urlParams = new URLSearchParams(queryString);
            const meetingId = urlParams.get('meetingId'); 
            buildMeetingDetailsDiv(meetingId);
        });

        function sortInstances(instances){
            var sortedInstances = instances.sort((a, b) => {
                var aStart = DateTime.fromFormat(a.start, CSV_DATE_FORMAT);
                var bStart = DateTime.fromFormat(b.start, CSV_DATE_FORMAT);
                return ( aStart.startOf("day") <= bStart.startOf("day") );
            });
            return sortedInstances;
        }

        async function buildMeetingDetailsDiv(meetingId){
            try{
                var meeting = await getRecord('meetings', meetingId);
                // too: get just instances for this meeting id
                var instances = await getAll('meetingInstances');
                var sortedInstances = sortInstances(instances);
                var prevDate = null;
                if( meeting ){
                    $('#topicName').text(meeting.topic);
                    for( var i=0; i<sortedInstances.length; i++){
                        var instance = sortedInstances[i];
                        if( instance.meetingId == meetingId){
                            var dtStartDate = DateTime.fromFormat(instance.start, CSV_DATE_FORMAT);
                            var startDateSimple = dtStartDate.toLocaleString(DateTime.DATE_SHORT);
                            var startDateWeekday = dtStartDate.toLocaleString(DateTime.DATE_MED_WITH_WEEKDAY);
                            var startTimeSimple = dtStartDate.toLocaleString(DateTime.TIME_SIMPLE);
                            var dtEndTime = DateTime.fromFormat(instance.end, CSV_DATE_FORMAT);
                            var endTimeSimple = dtEndTime.toLocaleString(DateTime.TIME_SIMPLE);

                            var duration = instance.duration;
                            var participants = instance.participants;

                            // TODO: just get attendance records associated for this instance
                            var allAttendanceRecords = await getAll('attendance');
                            var attendanceeRecords = {};  // todo: sort
                            for( var j=0; j<allAttendanceRecords.length; j++){
                                var attendance = allAttendanceRecords[j];
                                var dtAttendanceStart = DateTime.fromFormat(attendance.start, CSV_DATE_FORMAT);
                                var attendanceStartDate = dtAttendanceStart.toLocaleString(DateTime.DATE_SHORT);
                                if( attendanceStartDate == startDateSimple ) {
                                    if( typeof attendanceeRecords[attendance.email] == 'undefined' ) {
                                        attendanceeRecords[attendance.email] = {
                                            "email": attendance.email,
                                            attendance: []
                                        }
                                    }
                                    attendanceeRecords[attendance.email].attendance.push( attendance);
                                }
                            }

                            var attendanceRecordCount = Object.keys(attendanceeRecords).length;

                            $('#meetingInstanceList').append( `<div class="row"><a href="meetingInstance.html?meetingId=${encodeURIComponent(instance.meetingId)}&startDate=${startDateSimple}">${startDateWeekday}; ${startTimeSimple} -> ${endTimeSimple}, ${duration}m with ${attendanceRecordCount} participants</a></div></div>` );

                        }

                    }
                } else {
                    alert("unable to get meeting: " + meetingId);
                }

            } catch( err ) {
                console.log( err );
            }
        }



    </script>
</body>

</html>