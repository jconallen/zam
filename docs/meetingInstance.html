<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"
        integrity="sha256-NVP7i99bgATOVTHmgn6ByLNOezmSZ3lndUVEBk6XsBY=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"
        integrity="sha256-UWxf6lyCvfH7XEcrmq/cqc2m3IBrLBLOnWLC4Pw0gQQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/async@3.2.6/dist/async.min.js"
        integrity="sha256-uDzWtmm1K/XBN81NsKQ3dxp0KF3jz7XPO8F3WAA0Whg=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@8.0.3/build/umd.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>

<body>
    <div id="navbar"></div>

    <div class="container">
        <h1>Meeting Instance</h1>
        <h3 id="topicName"></h3>
        <p id="meetingDateTime"></p>

        <h3>Attendees <span id="attendeeCount"></span></h3>
        <div id="attendance" class="container">

        </div>
    </div>

    <!-- code -->
    <script src="js/utils.js"></script>

    <script type="text/javascript">

        $(function () {
            $("#navbar").load("navbar.html");
        });

        var students = {};
        
        window.addEventListener("load", async (event) => {
            await initDb();

            const queryString = window.location.search; 
            const urlParams = new URLSearchParams(queryString);
            const meetingId = urlParams.get('meetingId'); 
            const startDate = urlParams.get('startDate');

            var meeting = await getRecord('meetings', meetingId );
            if( meeting ) {
                var meetingInstance = await getRecord('meetingInstances', [ meetingId, startDate ] );
                if( meetingInstance ) {
                    $('#topicName').text( meeting.topic );
                    var startDateTime = parseDateString( meetingInstance.start );
                    var endDateTime = parseDateString( meetingInstance.end );
                    var duration = csvTimeDuration(meetingInstance.start, meetingInstance.end );
                    $('#meetingDateTime').text( `${startDateTime.dateSimple}, ${startDateTime.timeSimple} to ${endDateTime.timeSimple}, (${duration}m)`);

                    populateStudents( meetingId, meetingInstance.start );
                } else {
                    console.error( `Meeting instance: ${meetingId}, ${startDate} not found.`);
                }
            } else {
                console.error( `Meeting: ${meetingId} not found.`)
            }
        });

        async function populateStudents(meetingId, start){
            try{
                var studentRecords = await getAll('students');
                // now index them
                for( var i=0; i<studentRecords.length; i++){
                    students[ studentRecords[i].email ] = studentRecords[i];
                }

                // todo: only get records for this meeting instance
                var attendance = await getAll('attendance');
                var sortedAttendance = sortAttendance( attendance );
                // todo: sort by name
                var prevStudentEmail = null;
                for( var i=0; i<sortedAttendance.length; i++){
                    var attendanceRecord = sortedAttendance[i];
                    if( attendanceRecord.start == "10/01/2025 06:26:20 PM" ) {
                        console.log( attendanceRecord.meetingId + " " + attendanceRecord.start );
                    }
                    if( attendanceRecord.meetingId == meetingId && attendanceRecord.start == start ){
                        var student = students[sortedAttendance[i].email];
                        var parsedStart = parseDateString(attendanceRecord.start);
                        var parsedEnd = parseDateString(attendanceRecord.end);
                        if( prevStudentEmail != student.email ){
                            var div = 
                            `<div class="row w-50" style="padding-top:5px">
                                <a href="student.html?email=${student.email}">${student.name}</a>
                            </div>
                            <div class="row w-50" style="margin:5px;">
                                <div class="col">${parsedStart.timeSimple} to ${parsedEnd.timeSimple}</a></div>
                                <div class="col"><canvas id="${student.email}" style="width:100%;height:25px;border-style:solid;border-width:1px;"></canvas></div>
                            </div>`;
                            $('#attendance').append(div);
                            prevStudentEmail = student.email;
                        } else {
                            var div = 
                            `<div class="row w-50" style="margin:5px;">
                                <div class="col">${parsedStart.timeSimple} to ${parsedEnd.timeSimple}</div>
                                <div class="col"><canvas id="${student.email}" style="width:100%;height:25px;border-style:solid;border-width:1px;"></canvas></div>
                            </div>`;
                            $('#attendance').append(div);

                        }
                    }
                }

            } catch ( err ) {
                console.error( err );
            }

        }

        function sortAttendance(attendance){
            return attendance.sort((a, b) => {
                var aName = students[a.email].name;
                var bName = students[b.email].name;
                if( aName == bName ){
                    var aStart = DateTime.fromFormat(a.start,CSV_DATE_FORMAT);
                    var bStart = DateTime.fromFormat(b.start,CSV_DATE_FORMAT);
                    return aStart - bStart;
                }
                return aName.localeCompare( bName );
            });
        }




    </script>
</body>

</html>